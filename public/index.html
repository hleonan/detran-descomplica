<!DOCTYPE html>
<html lang="pt-BR">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Detran Descomplica</title>
  <style>
    *{margin:0;padding:0;box-sizing:border-box}
    body{font-family:-apple-system,BlinkMacSystemFont,'Segoe UI',Roboto,sans-serif;background:linear-gradient(135deg,#1a1a2e,#16213e);min-height:100vh;color:#fff}
    .container{max-width:800px;margin:0 auto;padding:20px}
    header{text-align:center;padding:40px 0}
    header h1{font-size:2.5rem;margin-bottom:10px;background:linear-gradient(90deg,#00d4ff,#00ff88);-webkit-background-clip:text;-webkit-text-fill-color:transparent}
    .card{background:rgba(255,255,255,0.05);border-radius:16px;padding:30px;margin-bottom:20px;border:1px solid rgba(255,255,255,0.1)}
    .card h2{font-size:1.3rem;margin-bottom:20px;color:#00d4ff}
    .form-group{margin-bottom:20px}
    .form-group label{display:block;margin-bottom:8px;color:#ccc}
    .form-group input{width:100%;padding:14px;border:2px solid rgba(255,255,255,0.1);border-radius:10px;background:rgba(255,255,255,0.05);color:#fff;font-size:1rem}
    .form-group input:focus{outline:none;border-color:#00d4ff}
    .btn{width:100%;padding:16px;border:none;border-radius:10px;font-size:1.1rem;font-weight:600;cursor:pointer;background:linear-gradient(90deg,#00d4ff,#00ff88);color:#1a1a2e}
    .btn:disabled{opacity:0.5;cursor:not-allowed}
    .status-bar{display:flex;justify-content:space-between;padding:15px 20px;background:rgba(0,212,255,0.1);border-radius:10px;margin-bottom:20px}
    .status-bar .value{font-weight:600;color:#00ff88}
    .message{padding:15px;border-radius:10px;margin-top:20px;display:none}
    .message.success{background:rgba(0,255,136,0.1);border:1px solid #00ff88;color:#00ff88;display:block}
    .message.error{background:rgba(255,68,68,0.1);border:1px solid #ff4444;color:#ff4444;display:block}
    .message.loading{background:rgba(0,212,255,0.1);border:1px solid #00d4ff;color:#00d4ff;display:block}
    .historico-item{display:flex;justify-content:space-between;align-items:center;padding:15px;background:rgba(255,255,255,0.03);border-radius:10px;margin-bottom:10px}
    .historico-item .info{flex:1}
    .historico-item .btn-download{padding:10px 20px;background:rgba(0,212,255,0.2);border:1px solid #00d4ff;color:#00d4ff;border-radius:8px;cursor:pointer}
    .empty-state{text-align:center;padding:40px;color:#666}
  </style>
</head>
<body>
  <div class="container">
    <header><h1>üöó Detran Descomplica</h1><p>Certid√£o Nada Consta Autom√°tica</p></header>
    <div class="status-bar"><div><span>Saldo 2Captcha: </span><span class="value" id="saldo">...</span></div><div><span>Status: </span><span class="value" id="status">Online</span></div></div>
    <div class="card">
      <h2>üìã Emitir Certid√£o</h2>
      <form id="formEmitir">
        <div class="form-group"><label>CPF</label><input type="text" id="cpf" placeholder="Digite o CPF" maxlength="14" required></div>
        <div class="form-group"><label>CNH</label><input type="text" id="cnh" placeholder="Digite a CNH" maxlength="11" required></div>
        <button type="submit" class="btn" id="btnEmitir">Emitir Certid√£o</button>
      </form>
      <div id="mensagem" class="message"></div>
    </div>
    <div class="card"><h2>üìÅ Hist√≥rico</h2><div id="historico"><div class="empty-state">Carregando...</div></div></div>
  </div>
  <script>
    document.getElementById('cpf').addEventListener('input',e=>{let v=e.target.value.replace(/\D/g,'').slice(0,11);if(v.length>9)v=v.replace(/(\d{3})(\d{3})(\d{3})(\d{2})/,'$1.$2.$3-$4');else if(v.length>6)v=v.replace(/(\d{3})(\d{3})(\d{1,3})/,'$1.$2.$3');else if(v.length>3)v=v.replace(/(\d{3})(\d{1,3})/,'$1.$2');e.target.value=v});
    async function carregarSaldo(){try{const r=await fetch('/api/saldo');const d=await r.json();document.getElementById('saldo').textContent=d.success?`$${d.balance.toFixed(3)}`:d.error}catch{document.getElementById('saldo').textContent='Erro'}}
    async function carregarHistorico(){try{const r=await fetch('/api/historico');const d=await r.json();const h=document.getElementById('historico');if(!d.certidoes?.length){h.innerHTML='<div class="empty-state">Nenhuma certid√£o</div>';return}h.innerHTML=d.certidoes.reverse().map(c=>`<div class="historico-item"><div class="info"><div><strong>CPF: ${c.cpf}</strong></div><div>${c.data} ‚Ä¢ ${c.paginas} p√°g</div></div><button class="btn-download" onclick="window.open('/api/download/${c.arquivo}')">üì• Baixar</button></div>`).join('')}catch{document.getElementById('historico').innerHTML='<div class="empty-state">Erro</div>'}}
    document.getElementById('formEmitir').addEventListener('submit',async e=>{e.preventDefault();const cpf=document.getElementById('cpf').value,cnh=document.getElementById('cnh').value,btn=document.getElementById('btnEmitir'),msg=document.getElementById('mensagem');if(!cpf||!cnh){msg.textContent='Preencha todos os campos';msg.className='message error';return}btn.disabled=true;btn.textContent='Aguarde...';msg.textContent='Processando... pode levar at√© 2 min';msg.className='message loading';try{const r=await fetch('/api/emitir',{method:'POST',headers:{'Content-Type':'application/json'},body:JSON.stringify({cpf,cnh})});const d=await r.json();if(d.success){msg.textContent='‚úÖ Certid√£o emitida!';msg.className='message success';carregarHistorico();carregarSaldo()}else{msg.textContent='‚ùå '+d.error;msg.className='message error'}}catch(e){msg.textContent='‚ùå Erro: '+e.message;msg.className='message error'}finally{btn.disabled=false;btn.textContent='Emitir Certid√£o'}});
    carregarSaldo();carregarHistorico();setInterval(carregarSaldo,30000);
  </script>
</body>
</html>
